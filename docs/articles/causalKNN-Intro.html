<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>causalKNN Introduction Vignette • causalKNN</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="causalKNN Introduction Vignette">
<meta property="og:description" content="causalKNN">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">causalKNN</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/causalKNN-Intro.html">causalKNN Introduction Vignette</a>
    </li>
    <li>
      <a href="../articles/causalKNN-Bootstrap.html">causalKNN Bootstrap Vignette</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/walterwzhang/causalKNN/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>causalKNN Introduction Vignette</h1>
                        <h4 data-toc-skip class="author">Walter
Zhang</h4>
            
            <h4 data-toc-skip class="date">August 28, 2018</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/walterwzhang/causalKNN/blob/HEAD/vignettes/causalKNN-Intro.Rmd" class="external-link"><code>vignettes/causalKNN-Intro.Rmd</code></a></small>
      <div class="hidden name"><code>causalKNN-Intro.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we demonstrate how to use the causalKNN package to
estimate heterogeneous treatment effects (with the causal KNN and
treatment effect projection methods). The direct causal KNN algorithm
will estimate treatment effects for our test sample. The treatment
effect projection (TEP) procedure will first project a treatment effect
on our training data set, and then use a regression algorithm to predict
treatments effects in our test sample.</p>
<p>Both of these methods are introduced in Hitsch and Misra 2018 <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. We will
consider simulated data under a RCT setting with a binary treatment.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>We first provide an overview of the causal KNN and TEP algorithm and
then demonstrate how to implement the estimation procedure with the
package. We will consider a simulated RCT scenario with training and
test data sets.</p>
<p>For both techniques we need to first determine the optimal K value to
be used. This optimal K value will be tuned by the transformed error
loss.</p>
<p>The causal KNN algorithm can be performed in the following steps.</p>
<ol style="list-style-type: decimal">
<li>For each observation in the training data set find the K nearest
treated and K nearest untreated neighbors in the training data set</li>
<li>Estimate the conditional average treatment effect using the mean
difference between the nearest treated and untreated units</li>
<li>Find the optimal K that yields the smallest RMSE of the CATE to the
transformed outcome</li>
<li>For each observation in the test data set find the K nearest treated
and K nearest untreated neighbors in the training data set</li>
<li>Compute the heterogeneous treatment effect estimates in the test set
using the optimal K</li>
</ol>
<p>The TEP procedure can also be broken down into a few steps.</p>
<ol style="list-style-type: decimal">
<li>For each observation in the training data set find the K nearest
treated and K nearest untreated neighbors</li>
<li>Estimate the conditional average treatment effect using the mean
difference between the nearest treated and untreated units</li>
<li>Find the optimal K that yields the smallest RMSE of the CATE to the
transformed outcome</li>
<li>Compute the heterogeneous treatment effect estimates in the training
set using the optimal K</li>
<li>Using the treatment effect estimates from the training set fit a
regression model and predict on the test set</li>
</ol>
<p>In the TEP procedure, steps 1 to 3 formulate the causal KNN
regression. Step 4 performs the treatment effect projection.</p>
<p>This package provides a set of functions that when run sequentially
will execute the steps for both methods and yield a heterogeneous
treatment effect prediction for our test set. For a more “off-the-shelf”
approach, the <code>causalknn_direct</code> wraps the direct causal KNN
functions and the <code>causalKNN_TEP</code> wraps all the TEP functions
into one.</p>
<p>The benefit of this estimation procedure is that once the K nearest
treated and untreated neighbors index matrices are computed and stored,
the subsequent steps execute relatively quickly. As a result, the
initial choice of <code>K</code> in the first step is crucial. When in
doubt, it is recommended to specify a larger <code>K</code>.</p>
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>We will consider simulated RCT data to demonstrate how to use the
package to estimate heterogeneous treatment effects.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234L</span><span class="op">)</span></span>
<span><span class="va">n</span>     <span class="op">&lt;-</span>   <span class="fl">5000</span>  <span class="co"># Number of Observations in training set</span></span>
<span><span class="va">p</span>     <span class="op">&lt;-</span>   <span class="fl">21</span>    <span class="co"># Number of Features</span></span>
<span><span class="va">key</span>   <span class="op">&lt;-</span>   <span class="fl">1</span><span class="op">:</span><span class="va">n</span>   <span class="co"># Individual indices</span></span>
<span></span>
<span><span class="va">n_test</span>     <span class="op">&lt;-</span>   <span class="fl">501</span>  <span class="co"># Number of Observations in test set</span></span>
<span><span class="va">key_test</span>   <span class="op">&lt;-</span>   <span class="fl">1</span><span class="op">:</span><span class="va">n_test</span></span>
<span></span>
<span><span class="va">X</span>     <span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">n</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">n</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">n</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X_test</span>           <span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_test</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">X_test</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>       <span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span></span>
<span><span class="va">X_test</span><span class="op">[</span>,<span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>   <span class="op">&lt;-</span>   <span class="fl">5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TE</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="va">p</span><span class="op">/</span><span class="fl">3</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">W</span>    <span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">Y</span>    <span class="op">&lt;-</span>   <span class="va">TE</span> <span class="op">*</span> <span class="va">W</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="determining-optimal-k">Determining Optimal K<a class="anchor" aria-label="anchor" href="#determining-optimal-k"></a>
</h3>
<p>For both estimation procedures we need to first find an optimal K
value.</p>
<div class="section level4">
<h4 id="compute-k-nearest-neighbors-among-treated-and-untreated">Compute K nearest neighbors among treated and untreated<a class="anchor" aria-label="anchor" href="#compute-k-nearest-neighbors-among-treated-and-untreated"></a>
</h4>
<p>We first need to compute the K nearest neighbors index matrix for the
each observation in the training set for its untreated and treated
nearest neighbors. The <code>knn_index_mat</code> function wraps the
<code>knn.index.dist</code> function from the <code>KernelKnn</code>
package. This allows us to compute the KNN index matrix for a variety of
possible distance metrics that are supported by the
<code>knn.index.dist</code> function. For our example, we will use the
default Euclidean distance metric.</p>
<p>We also need to choose how large our KNN index matrices will be (by
choosing a <code>K</code> value). It is important to choose a
<code>K</code> large enough that the optimal <code>K</code> routine down
the line will have enough <code>K</code> values to search through.
However, choosing a too large of a <code>K</code> value leads to a
longer run time and the index matrices will take up more memory in R (as
the KNN algorithm is memory-based learning).</p>
<p>The function is parallelized using Open MP in the back end, and we
can set the number of threads to use for the nearest neighbor searching
procedure.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k</span>                 <span class="op">&lt;-</span>   <span class="fl">120L</span>         <span class="co"># Number of NN to search</span></span>
<span><span class="va">distance_metric</span>   <span class="op">&lt;-</span>   <span class="st">"euclidean"</span>  <span class="co"># Distance metric</span></span>
<span><span class="va">keep_dist</span>         <span class="op">&lt;-</span>   <span class="cn">FALSE</span>        <span class="co"># Drop the distance matrices</span></span>
<span><span class="va">threads</span>           <span class="op">&lt;-</span>   <span class="fl">1L</span>           <span class="co"># Number of threads to use</span></span>
<span></span>
<span><span class="va">knn_index_list</span>    <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/knn_index_mat.html">knn_index_mat</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">W</span>, <span class="va">k</span>,</span>
<span>                                     distance_metric <span class="op">=</span> <span class="va">distance_metric</span>,</span>
<span>                                     keep_dist       <span class="op">=</span> <span class="va">keep_dist</span>,</span>
<span>                                     threads         <span class="op">=</span> <span class="va">threads</span><span class="op">)</span></span></code></pre></div>
<div class="section level5">
<h5 id="finding-the-optimal-k">Finding the optimal K<a class="anchor" aria-label="anchor" href="#finding-the-optimal-k"></a>
</h5>
<p>Now that we have the K nearest neighbor index stored, we can compute
the causal KNN treatment effects for a given K value. To find the
optimal K value, we will use the <code>knn_optimal_k</code>
function.</p>
<p>We will tune K based on on the transformed outcome loss or the mean
squared difference between <span class="math inline">\(\hat{\tau}_K(x)\)</span> and the transformed
outcome <span class="math inline">\(Y_i^*\)</span>. The transformed
outcome is defined as <span class="math display">\[Y_i^* = \frac{W_i -
e(X_i)}{e(X_i)(1-e(X_i))} Y_i\]</span> where <span class="math inline">\(W_i\)</span> is the observed treatment indicator,
<span class="math inline">\(X_i\)</span> is the vector of features for
each individual, and <span class="math inline">\(e(X_i)\)</span> is the
estimated propensity score. Under the assumption of unconfoundedness,
the transformed outcome is an unbiased estimate of the conditional
average treatment effect. In our RCT setting, we know the propensity
score by experimental design. The optimal K value will be the K that
minimizes the transformed error loss of <span class="math inline">\(E[(Y_i^* - \hat\tau_K(X_i))^2|X_i]\)</span>.</p>
<p>To specify a vector of K values to search over,
<code>knn_optimal_k</code> takes in <code>N_step</code> and
<code>K_step</code> parameters. The <code>K_step</code> parameter
determines the starting <code>K</code> value and the step size between
<code>K</code> values in the vector. The <code>N_step</code> determines
the number of total points to search over. In our example, we set
<code>N_step</code> to <span class="math inline">\(20\)</span> and
<code>K_step</code> to <span class="math inline">\(5\)</span>, and this
will give us a vector of <code>K</code> values from <span class="math inline">\(5\)</span> to <span class="math inline">\(100\)</span> with step increments of <span class="math inline">\(5\)</span>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N_step</span>   <span class="op">&lt;-</span>   <span class="fl">20</span>  <span class="co"># How many steps to take</span></span>
<span><span class="va">K_step</span>   <span class="op">&lt;-</span>   <span class="fl">5</span>   <span class="co"># Value between steps and starting value</span></span>
<span></span>
<span><span class="va">optimal_k_list</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/knn_optimal_k.html">knn_optimal_k</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">W</span>, <span class="va">Y</span>, <span class="va">key</span>, <span class="va">N_step</span>, <span class="va">K_step</span>, <span class="va">knn_index_list</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the RMSE of transformed error loss. As expected, we see
an elbow plot when we are tuning for optimal K. By default, the
<code>knn_optimal_k</code> function will suggest to use the
<code>K</code> value that yields the minimum RMSE.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">optimal_k_list</span><span class="op">$</span><span class="va">k_vec</span>, <span class="va">optimal_k_list</span><span class="op">$</span><span class="va">rmse_vec</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylab <span class="op">=</span> <span class="st">"RMSE"</span>, xlab <span class="op">=</span> <span class="st">"K"</span><span class="op">)</span></span></code></pre></div>
<p><img src="causalKNN-Intro_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>We can use the <code>knn_optimal_k_separate</code> function find
optimal <code>K</code> values separately for treated and untreated
nearest neighbors.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="direct-causal-knn">Direct Causal KNN<a class="anchor" aria-label="anchor" href="#direct-causal-knn"></a>
</h3>
<p>Now armed with our optimal <code>K</code> value, we can compute
estimates of treatment effect on the test set with causal KNN. We first
need to compute the set of <code>K</code> nearest neighbor matrices of
our test set.</p>
<p>We compute the CATE by <span class="math display">\[\hat{\tau}_K(x) =
\frac{1}{K} \sum_{i \in N_k(x,1)} Y_i - \frac{1}{K} \sum_{i \in
N_{K}(x,0)} Y_i\]</span> where <span class="math inline">\(N_{K}(x,w)\)</span> is the set of the <span class="math inline">\(K\)</span> nearest neighbors with treatment status
<span class="math inline">\(w \in \{0,1\}\)</span> in the training
sample, <span class="math inline">\(x\)</span> is the test set features,
and <span class="math inline">\(Y_i\)</span> is the observed outcomes in
the training sample.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knn_index_test_list</span>    <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/knn_index_mat.html">knn_index_mat</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">W</span>, <span class="va">k</span>,</span>
<span>                                          DF_test         <span class="op">=</span> <span class="va">X_test</span>,</span>
<span>                                          distance_metric <span class="op">=</span> <span class="va">distance_metric</span>,</span>
<span>                                          keep_dist       <span class="op">=</span> <span class="va">keep_dist</span>,</span>
<span>                                          threads         <span class="op">=</span> <span class="va">threads</span><span class="op">)</span></span></code></pre></div>
<p>Then, with our pair or treated/untreated <code>K</code> nearest
neighbor matrices of the test set to the training set, we can compute
the direct causal KNN treatment effect for the test set.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">causal_KNN_test_DF</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/causalknn_treatment_effect.html">causalknn_treatment_effect</a></span><span class="op">(</span><span class="va">W</span>, <span class="va">Y</span>, <span class="va">key</span>, <span class="va">optimal_k_list</span><span class="op">$</span><span class="va">optimal_K</span>,</span>
<span>                                                     <span class="va">knn_index_test_list</span>,</span>
<span>                                                     key_test <span class="op">=</span> <span class="va">key_test</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="treatment-effect-projection">Treatment Effect Projection<a class="anchor" aria-label="anchor" href="#treatment-effect-projection"></a>
</h3>
<div class="section level4">
<h4 id="causal-knn">Causal KNN<a class="anchor" aria-label="anchor" href="#causal-knn"></a>
</h4>
<p>We will first use causal KNN to get a projection of the CATE in the
training set.</p>
<p>We similarly compute the training sample CATE by <span class="math display">\[\hat{\tau}_K(x) = \frac{1}{K} \sum_{i \in
N_k(x,1)} Y_i - \frac{1}{K} \sum_{i \in N_{K}(x,0)} Y_i\]</span> where
<span class="math inline">\(N_{K}(x,w)\)</span> is the set of the <span class="math inline">\(K\)</span> nearest neighbors with treatment status
<span class="math inline">\(w \in \{0,1\}\)</span>, <span class="math inline">\(x\)</span> is the features, and <span class="math inline">\(Y_i\)</span> is the observed outcomes. We do not
consider an observation to be its own nearest neighbor.</p>
</div>
<div class="section level4">
<h4 id="estimate-the-cate-given-optimal-k">Estimate the CATE given Optimal K<a class="anchor" aria-label="anchor" href="#estimate-the-cate-given-optimal-k"></a>
</h4>
<p>Now that we have our optimal K value, we can compute the CATE for our
causal KNN regression. We can call the
<code>causalknn_treatment_effect</code> function to compute our
CATE.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">causal_KNN_DF</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/causalknn_treatment_effect.html">causalknn_treatment_effect</a></span><span class="op">(</span><span class="va">W</span>, <span class="va">Y</span>, <span class="va">key</span>, <span class="va">optimal_k_list</span><span class="op">$</span><span class="va">optimal_K</span>, <span class="va">knn_index_list</span><span class="op">)</span></span></code></pre></div>
<p>For the separate optimal <code>K</code> case, we can pass a vector of
the K values into the <code>causalknn_treatment_effect</code> function,
where the first element of the vector is the K for the untreated nearest
neighbors and the second element of the vector is the <code>K</code> for
the treated nearest neighbors.</p>
</div>
</div>
<div class="section level3">
<h3 id="treatment-effect-regression">Treatment Effect Regression<a class="anchor" aria-label="anchor" href="#treatment-effect-regression"></a>
</h3>
<p>With the CATE estimate in the training set, we will fit a regression
using our projected treatment effect estimates on the training set and
then predict on the test set. More formally, we project the causal KNN
treatment effect estimates <span class="math inline">\(\hat\tau_{K}
(X_i)\)</span> on to the features <span class="math inline">\(X_i\)</span>. The regression step will also allow
us to regularize our causal KNN estimates. We can use any regression
algorithm for causal KNN treatment effect estimates, and the package
allows for an easy implementation of the Elastic-Net family of
models.</p>
<div class="section level4">
<h4 id="elastic-net">Elastic Net<a class="anchor" aria-label="anchor" href="#elastic-net"></a>
</h4>
<p>We will consider the Elastic-Net family of regression models for our
treatment effect estimates. The <code>tep_enet</code> function wraps the
<code>cv.glmnet</code> function from the <code>glmnet</code> package to
provide a cross-validated Elastic-Net. By setting the parameter
<code>alpha</code> to <code>NULL</code>, the function will also
cross-validate to find the optimal <code>alpha</code> value. For our
example, we will set <code>alpha</code> to <span class="math inline">\(0\)</span> for a Ridge Regression.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TEP_results_list</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/tep_enet.html">tep_enet</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">causal_KNN_DF</span><span class="op">$</span><span class="va">treatment_effect</span>, <span class="va">X_test</span>, alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="off-the-shelf-approach">“Off-the-shelf” Approach<a class="anchor" aria-label="anchor" href="#off-the-shelf-approach"></a>
</h3>
<p>Alternatively, we can run the all of the functions for the direct
Causal KNN or the Causal KNN TEP in one step with our wrapper functions,
<code>causalKNN_direct</code> and <code>causalKNN_TEP</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_list_direct</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/causalKNN_direct.html">causalKNN_direct</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">W</span>, <span class="va">Y</span>, <span class="va">key</span>, <span class="va">X_test</span>, <span class="va">key_test</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_list_TEP</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/causalKNN_TEP.html">causalKNN_TEP</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">W</span>, <span class="va">Y</span>, <span class="va">key</span>, <span class="va">X_test</span>, <span class="va">key_test</span>,</span>
<span>                                      tep_e_net_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If we disagree with the automatic selection of the model parameters,
we can manually re-run each step given the <code>causalKNN_TEP</code>
output.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimal_k_list_1</span>   <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/knn_optimal_k.html">knn_optimal_k</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">W</span>, <span class="va">Y</span>, <span class="va">key</span>, <span class="va">N_step</span>, <span class="va">K_step</span>, <span class="va">results_list_TEP</span><span class="op">$</span><span class="va">knn_index_list</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>The <code>causalKNN</code> provides a set of functions to implement
the direct Causal KNN regression and Causal KNN treatment effect
projection (TEP). For the causal KNN regression,
<code>knn_index_mat</code> computes nearest neighbor index matrices of
treated and untreated nearest neighbors, <code>knn_optimal_k</code>
tunes the causal KNN regression to find an optimal <code>K</code> value,
and <code>causalknn_treatment_effect</code> estimates the treatment
effect for a given <code>K</code>. The
<code>causalknn_treatment_effect</code> function can be used to estimate
treatment effects for the training or test sets. For the treatment
effect projection, <code>tep_enet</code> fits an elastic net with the
projected Causal KNN treatment effect and then predicts the treatment
effects on a test set. An “off-the-shelf” approach is also possible with
the <code>causalKNN_TEP</code> and <code>causalKNN_TEP</code>, but it is
<em>highly recommended</em> for the user to consider manually tweaking
the model parameters.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>Hitsch, Günter J. and Misra, Sanjog, Heterogeneous
Treatment Effects and Optimal Targeting Policy Evaluation (January 28,
2018). <a href="https://dx.doi.org/10.2139/ssrn.3111957" class="external-link uri">https://dx.doi.org/10.2139/ssrn.3111957</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Walter Zhang, Guenter Hitsch, Sanjog Misra.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
